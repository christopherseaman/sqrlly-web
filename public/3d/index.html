<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Variable Plot</title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            touch-action: none;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 15px;
            font-size: clamp(1.2rem, 4vw, 2rem);
        }
        
        #container {
            width: 100%;
            height: 70vh;
            min-height: 400px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            position: relative;
            touch-action: none;
        }
        
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
            max-width: 250px;
            font-size: 12px;
        }
        
        .legend {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }
        
        .color-box {
            width: 18px;
            height: 18px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>3D Variable Plot</h1>
    
    <div id="container">
        <div id="info">
            <strong>Controls:</strong><br>
            • Drag: Rotate<br>
            • Scroll/Pinch: Zoom<br>
            • Tap: Select point
        </div>
    </div>
    
    <div class="legend">
        <div class="legend-item">
            <div class="color-box" style="background: #ff6b6b;"></div>
            <span>Language (4)</span>
        </div>
        <div class="legend-item">
            <div class="color-box" style="background: #4ecdc4;"></div>
            <span>Motor (6)</span>
        </div>
        <div class="legend-item">
            <div class="color-box" style="background: #45b7d1;"></div>
            <span>VizSpat_Math (4)</span>
        </div>
        <div class="legend-item">
            <div class="color-box" style="background: #f7d794;"></div>
            <span>Attention (3)</span>
        </div>
        <div class="legend-item">
            <div class="color-box" style="background: #c44569;"></div>
            <span>Social (2)</span>
        </div>
        <div class="legend-item">
            <div class="color-box" style="background: #a55eea;"></div>
            <span>Orphan (2)</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Embedded fallback data
        const fallbackData = [
            {Variable: "DiffRead", Dim1: 1.238, Dim2: -0.045, Dim3: -0.2295, Factor: "Language"},
            {Variable: "DiffSpell", Dim1: 1.8774, Dim2: -0.8018, Dim3: 0.017, Factor: "Language"},
            {Variable: "Stutter", Dim1: 0.0359, Dim2: -0.0642, Dim3: -0.1621, Factor: "Language"},
            {Variable: "VerbalIn", Dim1: 0.1731, Dim2: 0.1948, Dim3: -0.1769, Factor: "Language"},
            {Variable: "DiffHand", Dim1: 0.7669, Dim2: -0.4953, Dim3: 0.6001, Factor: "Motor"},
            {Variable: "Clumsy", Dim1: 0.1312, Dim2: -0.7774, Dim3: -0.098, Factor: "Motor"},
            {Variable: "MotorTic", Dim1: 0.1595, Dim2: -0.0113, Dim3: -0.2398, Factor: "Motor"},
            {Variable: "DiffMath", Dim1: 1.0343, Dim2: 1.784, Dim3: -0.695, Factor: "VizSpat_Math"},
            {Variable: "DiffGeom", Dim1: 0.9249, Dim2: 2.2854, Dim3: -0.8392, Factor: "VizSpat_Math"},
            {Variable: "L_Rconf", Dim1: 0.7634, Dim2: -1.1755, Dim3: 0.1672, Factor: "Motor"},
            {Variable: "DiffNavi", Dim1: 0.8354, Dim2: -0.1435, Dim3: -0.9308, Factor: "VizSpat_Math"},
            {Variable: "DiffMap", Dim1: 0.6858, Dim2: 0.1603, Dim3: -0.1224, Factor: "VizSpat_Math"},
            {Variable: "DiffDraw", Dim1: 0.5208, Dim2: -0.2991, Dim3: 1.6263, Factor: "Motor"},
            {Variable: "DiffRhy", Dim1: 0.4258, Dim2: -1.3697, Dim3: -0.0466, Factor: "Motor"},
            {Variable: "FreqMist", Dim1: 0.0776, Dim2: 0.7209, Dim3: 0.6961, Factor: "Attention"},
            {Variable: "BoredEas", Dim1: -1.1012, Dim2: 0.5841, Dim3: 1.9621, Factor: "Attention"},
            {Variable: "DiffAtt", Dim1: -0.7167, Dim2: 1.0276, Dim3: 1.1602, Factor: "Attention"},
            {Variable: "AfraidMeet", Dim1: -1.8845, Dim2: -1.1798, Dim3: -1.0702, Factor: "Social"},
            {Variable: "PreferAlone", Dim1: -3.8078, Dim2: -0.4847, Dim3: -0.309, Factor: "Social"},
            {Variable: "AfraidNew", Dim1: -1.36, Dim2: -0.2304, Dim3: -1.3577, Factor: "Orphan"},
            {Variable: "Tantrums", Dim1: -0.8194, Dim2: 0.3506, Dim3: 0.0482, Factor: "Orphan"}
        ];

        let data = [];
        
        // Load TSV with fallback
        function loadData() {
            fetch('plot-data.tsv')
                .then(response => response.text())
                .then(text => {
                    // Simple TSV parsing
                    const lines = text.trim().split('\n');
                    const headers = lines[0].split('\t');
                    data = lines.slice(1).map(line => {
                        const values = line.split('\t');
                        return {
                            Variable: values[0],
                            Dim1: parseFloat(values[1]),
                            Dim2: parseFloat(values[2]),
                            Dim3: parseFloat(values[3]),
                            Factor: values[4]
                        };
                    });
                    console.log('Loaded TSV data');
                    initVisualization();
                })
                .catch(() => {
                    data = fallbackData;
                    console.log('Using fallback data');
                    initVisualization();
                });
        }

        function initVisualization() {

        // Colors for factors
        const colors = {
            "Language": 0xff6b6b,
            "Motor": 0x4ecdc4,
            "VizSpat_Math": 0x45b7d1,
            "Attention": 0xf7d794,
            "Social": 0xc44569,
            "Orphan": 0xa55eea
        };

        // Setup
        const container = document.getElementById('container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x2a2a2a);
        
        const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        // Create axes
        const axisLength = 6;
        const xAxis = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(axisLength,0,0)]);
        const yAxis = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(0,axisLength,0)]);
        const zAxis = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(0,0,axisLength)]);
        
        scene.add(new THREE.Line(xAxis, new THREE.LineBasicMaterial({ color: 0xff4444 })));
        scene.add(new THREE.Line(yAxis, new THREE.LineBasicMaterial({ color: 0x44ff44 })));
        scene.add(new THREE.Line(zAxis, new THREE.LineBasicMaterial({ color: 0x4444ff })));

        // Create data points
        const spheres = [];
        data.forEach(point => {
            const geometry = new THREE.SphereGeometry(0.12, 16, 16);
            const material = new THREE.MeshLambertMaterial({ color: colors[point.Factor], opacity: 0.85, transparent: true });
            const sphere = new THREE.Mesh(geometry, material);
            sphere.position.set(point.Dim1, point.Dim2, point.Dim3);
            sphere.userData = { variable: point.Variable, factor: point.Factor };
            scene.add(sphere);
            spheres.push(sphere);
        });

        // Camera controls
        let isDown = false;
        let mouseX = 0, mouseY = 0;
        let rotX = Math.PI * 0.1, rotY = Math.PI * 0.25; // Start with nice angle
        let distance = 10;
        let lastTouch = 0;

        camera.position.set(5, 5, 5);
        camera.lookAt(0, 0, 0);

        function updateCamera() {
            const x = distance * Math.sin(rotY) * Math.cos(rotX);
            const y = distance * Math.sin(rotX);
            const z = distance * Math.cos(rotY) * Math.cos(rotX);
            camera.position.set(x, y, z);
            camera.lookAt(0, 0, 0);
        }

        function onStart(e) {
            e.preventDefault();
            isDown = true;
            const coords = e.touches ? e.touches[0] : e;
            mouseX = coords.clientX;
            mouseY = coords.clientY;
            if (e.touches && e.touches.length === 2) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                lastTouch = Math.sqrt(dx*dx + dy*dy);
            }
        }

        function onMove(e) {
            if (!isDown) return;
            e.preventDefault();
            
            if (e.touches && e.touches.length === 2) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const touchDist = Math.sqrt(dx*dx + dy*dy);
                if (lastTouch > 0) {
                    distance /= (touchDist / lastTouch);
                    distance = Math.max(3, Math.min(20, distance));
                }
                lastTouch = touchDist;
            } else {
                const coords = e.touches ? e.touches[0] : e;
                const deltaX = coords.clientX - mouseX;
                const deltaY = coords.clientY - mouseY;
                rotY += deltaX * 0.01;
                rotX += deltaY * 0.01;
                rotX = Math.max(-Math.PI/2, Math.min(Math.PI/2, rotX));
                mouseX = coords.clientX;
                mouseY = coords.clientY;
            }
            updateCamera();
        }

        function onEnd() {
            isDown = false;
            lastTouch = 0;
        }

        // Events
        renderer.domElement.addEventListener('mousedown', onStart);
        renderer.domElement.addEventListener('touchstart', onStart);
        renderer.domElement.addEventListener('mousemove', onMove);
        renderer.domElement.addEventListener('touchmove', onMove);
        renderer.domElement.addEventListener('mouseup', onEnd);
        renderer.domElement.addEventListener('touchend', onEnd);

        renderer.domElement.addEventListener('wheel', e => {
            e.preventDefault();
            distance += e.deltaY * 0.01;
            distance = Math.max(3, Math.min(20, distance));
            updateCamera();
        });

        // Selection
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let selected = null;

        function onTap(e) {
            if (isDown) return;
            const rect = renderer.domElement.getBoundingClientRect();
            const coords = e.touches ? e.touches[0] : e;
            mouse.x = ((coords.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((coords.clientY - rect.top) / rect.height) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            const hits = raycaster.intersectObjects(spheres);
            
            if (selected) selected.scale.set(1, 1, 1);
            
            if (hits.length > 0) {
                selected = hits[0].object;
                selected.scale.set(1.6, 1.6, 1.6);
                document.getElementById('info').innerHTML = `
                    <strong>${selected.userData.variable}</strong><br>
                    Factor: ${selected.userData.factor}<br>
                    Coords: (${selected.position.x.toFixed(2)}, ${selected.position.y.toFixed(2)}, ${selected.position.z.toFixed(2)})
                `;
            } else {
                selected = null;
                document.getElementById('info').innerHTML = `
                    <strong>Controls:</strong><br>
                    • Drag: Rotate<br>
                    • Scroll/Pinch: Zoom<br>
                    • Tap: Select point
                `;
            }
        }

        renderer.domElement.addEventListener('click', onTap);

        // Lighting
        scene.add(new THREE.AmbientLight(0x404040, 0.6));
        const light = new THREE.DirectionalLight(0xffffff, 0.8);
        light.position.set(1, 1, 1);
        scene.add(light);

        // Render loop
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });

        animate();
        }

        // Start loading
        loadData();
    </script>
</body>
</html>
